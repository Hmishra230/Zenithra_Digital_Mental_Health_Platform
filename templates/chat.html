{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <div class="flex h-screen max-h-screen">
            <!-- Sidebar -->
            <div class="w-1/4 bg-gray-800 text-white rounded-l-2xl flex flex-col">
                <div class="p-6 border-b border-gray-700">
                    <h2 class="text-xl font-bold mb-2">Chat History</h2>
                    <div class="text-sm text-gray-400">Previous conversations</div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div class="p-3 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer transition">
                        <div class="flex items-center space-x-2 mb-1">
                            <i data-lucide="thumbs-up" class="w-4 h-4 text-blue-400"></i>
                            <span class="font-medium">Counseling</span>
                        </div>
                        <div class="text-xs text-gray-400 hindi-text">कैसा लग रहा (How are you feeling)</div>
                    </div>
                    
                    <div class="p-3 rounded-lg hover:bg-gray-700 cursor-pointer transition">
                        <div class="flex items-center space-x-2 mb-1">
                            <i data-lucide="book" class="w-4 h-4 text-green-400"></i>
                            <span class="font-medium">Study Stress</span>
                        </div>
                        <div class="text-xs text-gray-400">Exam preparation help</div>
                    </div>
                    
                    <div class="p-3 rounded-lg hover:bg-gray-700 cursor-pointer transition">
                        <div class="flex items-center space-x-2 mb-1">
                            <i data-lucide="heart" class="w-4 h-4 text-red-400"></i>
                            <span class="font-medium">Mood Support</span>
                        </div>
                        <div class="text-xs text-gray-400 hindi-text">मूड सहायता</div>
                    </div>
                    
                    <div class="p-3 rounded-lg hover:bg-gray-700 cursor-pointer transition">
                        <div class="flex items-center space-x-2 mb-1">
                            <i data-lucide="users" class="w-4 h-4 text-purple-400"></i>
                            <span class="font-medium">Student Support</span>
                        </div>
                        <div class="text-xs text-gray-400 hindi-text">छात्र सहायता</div>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-700">
                    <div class="mb-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <i data-lucide="bookmark" class="w-4 h-4 text-blue-400"></i>
                            <span class="font-medium">Saved Resources</span>
                        </div>
                        <div class="text-xs text-gray-400 hindi-text">1800 सेव संसाधन</div>
                    </div>
                    
                    <div class="bg-red-600 p-3 rounded-lg">
                        <div class="flex items-center space-x-2 mb-1">
                            <i data-lucide="phone" class="w-4 h-4"></i>
                            <span class="font-bold text-sm">Crisis Resources</span>
                        </div>
                        <div class="text-xs">
                            National Helpline: 1800-XXX-XXX40<br>
                            <span class="text-red-200 hindi-text">(समय: 1800+क्रि में)</span>
                        </div>
                    </div>
                    
                    <button class="w-full mt-4 p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition">
                        <i data-lucide="settings" class="w-4 h-4 mx-auto"></i>
                    </button>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="flex-1 bg-white rounded-r-2xl flex flex-col">
                <!-- Chat Header -->
                <div class="p-6 border-b bg-gradient-to-r from-blue-50 to-purple-50 rounded-tr-2xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">AI Mental Health Support</h1>
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                <span>Online • Ready to help</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="more-vertical" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
                    <!-- Welcome Message -->
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-2xl rounded-tl-lg max-w-md">
                            <div class="text-sm text-blue-600 font-semibold mb-1">AI Assistant</div>
                            <p class="hindi-text">नमस्ते! We'll treat everything you recide with true confidentiality.</p>
                            <div class="text-xs text-gray-500 mt-2 flex items-center">
                                <span>23:41</span>
                                <i data-lucide="user" class="w-3 h-3 ml-2"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Sample Messages -->
                    <div class="flex items-start space-x-3 justify-end">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-2xl rounded-tr-lg max-w-md">
                            <p>Very your first time? I've mind you recide with true you thoughts!</p>
                            <div class="text-xs text-blue-100 mt-2 flex items-center justify-end">
                                <span>23:42</span>
                                <i data-lucide="user" class="w-3 h-3 ml-2"></i>
                            </div>
                        </div>
                        <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                        </div>
                    </div>

                    <!-- AI Response -->
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-2xl rounded-tl-lg max-w-md">
                            <div class="text-sm text-gray-600 font-semibold mb-1">AI Assistant</div>
                            <p>If this was no para-image at the you you'll willing for destiny!</p>
                            <div class="text-xs text-gray-500 mt-2 flex items-center">
                                <span>23:43</span>
                                <i data-lucide="bot" class="w-3 h-3 ml-2"></i>
                            </div>
                        </div>
                    </div>

                    <!-- More messages from conversation history -->
                    {% for conversation in conversations %}
                        <!-- User Message -->
                        <div class="flex items-start space-x-3 justify-end">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-2xl rounded-tr-lg max-w-md">
                                <p>{{ conversation.user_message }}</p>
                                <div class="text-xs text-blue-100 mt-2 flex items-center justify-end">
                                    <span>{{ conversation.timestamp.strftime('%H:%M') }}</span>
                                    <i data-lucide="user" class="w-3 h-3 ml-2"></i>
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                            </div>
                        </div>

                        <!-- AI Response -->
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                                <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                            </div>
                            <div class="{% if conversation.crisis_detected %}bg-red-50 border border-red-200{% else %}bg-gray-50{% endif %} p-4 rounded-2xl rounded-tl-lg max-w-md">
                                <div class="text-sm {% if conversation.crisis_detected %}text-red-600{% else %}text-gray-600{% endif %} font-semibold mb-1 flex items-center">
                                    <span>AI Assistant</span>
                                    {% if conversation.crisis_detected %}
                                        <span class="ml-2 bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-xs">Crisis Alert</span>
                                    {% endif %}
                                </div>
                                <p class="whitespace-pre-wrap">{{ conversation.bot_response }}</p>
                                <div class="text-xs text-gray-500 mt-2 flex items-center">
                                    <span>{{ conversation.timestamp.strftime('%H:%M') }}</span>
                                    <i data-lucide="bot" class="w-3 h-3 ml-2"></i>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="hidden flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-2xl rounded-tl-lg">
                            <div class="flex space-x-2">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-6 border-t bg-gray-50">
                    <div class="flex items-center space-x-4">
                        <button class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="info" class="w-5 h-5"></i>
                        </button>
                        <button class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="paperclip" class="w-5 h-5"></i>
                        </button>
                        <button class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="smile" class="w-5 h-5"></i>
                        </button>
                        
                        <div class="flex-1 relative">
                            <textarea 
                                id="message-input"
                                placeholder="Type your message here... यहाँ अपना संदेश लिखें..."
                                class="w-full p-4 pr-12 border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none hindi-text"
                                rows="1"
                            ></textarea>
                            <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <i data-lucide="mic" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <button 
                            onclick="sendMessage()"
                            id="send-button"
                            class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-3 rounded-2xl hover:from-blue-600 hover:to-blue-700 transition duration-300"
                        >
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3 text-xs text-gray-500 text-center">
                        Press Enter to send, Shift+Enter for new line • 
                        <span id="char-count">0/500</span>
                    </div>
                </div>

                <!-- Quick Response Buttons -->
                <div class="px-6 pb-4">
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button onclick="sendQuickMessage('Exam Stress')" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-4 py-2 rounded-full text-sm transition">
                            📚 Exam Stress
                        </button>
                        <button onclick="sendQuickMessage('Loneliness')" class="bg-purple-100 hover:bg-purple-200 text-purple-800 px-4 py-2 rounded-full text-sm transition">
                            🏠 Loneliness  
                        </button>
                        <button onclick="sendQuickMessage('Homesickness')" class="bg-green-100 hover:bg-green-200 text-green-800 px-4 py-2 rounded-full text-sm transition">
                            🏠 Homesickness
                        </button>
                        <button onclick="sendQuickMessage('Time Management')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-2 rounded-full text-sm transition">
                            ⏰ Time Management
                        </button>
                        <button onclick="sendQuickMessage('Sleep Troubles')" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-4 py-2 rounded-full text-sm transition">
                            😴 Sleep Troubles
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const chatMessages = document.getElementById('chat-messages');
const charCount = document.getElementById('char-count');

// Character counter
messageInput.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = `${length}/500`;
    
    if (length > 500) {
        charCount.classList.add('text-red-500');
        sendButton.disabled = true;
    } else {
        charCount.classList.remove('text-red-500');
        sendButton.disabled = false;
    }
});

function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || message.length > 500) return;
    
    // Add user message to chat
    addMessageToChat(message, 'user');
    messageInput.value = '';
    charCount.textContent = '0/500';
    
    // Show typing indicator
    showTyping(true);
    
    // Send to server
    fetch('/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        showTyping(false);
        
        if (data.error) {
            addMessageToChat('Sorry, there was an error processing your message. Please try again or contact support.', 'bot');
        } else {
            addMessageToChat(data.response, 'bot', data.crisis_detected);
        }
    })
    .catch(error => {
        showTyping(false);
        addMessageToChat('Connection error. Please check your internet connection and try again.', 'bot');
        console.error('Error:', error);
    });
}

function sendQuickMessage(message) {
    messageInput.value = message;
    sendMessage();
}

function addMessageToChat(message, sender, crisis = false) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="flex items-start space-x-3 justify-end slide-up">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-2xl rounded-tr-lg max-w-md">
                    <p>${message}</p>
                    <div class="text-xs text-blue-100 mt-2 flex items-center justify-end">
                        <span>${timeString}</span>
                        <i data-lucide="user" class="w-3 h-3 ml-2"></i>
                    </div>
                </div>
                <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                </div>
            </div>
        `;
    } else {
        const bgClass = crisis ? 'bg-red-50 border border-red-200' : 'bg-gray-50';
        const textColorClass = crisis ? 'text-red-600' : 'text-gray-600';
        const crisisBadge = crisis ? '<span class="ml-2 bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-xs">Crisis Alert</span>' : '';
        
        messageDiv.innerHTML = `
            <div class="flex items-start space-x-3 slide-up">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                    <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <div class="${bgClass} p-4 rounded-2xl rounded-tl-lg max-w-md">
                    <div class="text-sm ${textColorClass} font-semibold mb-1 flex items-center">
                        <span>AI Assistant</span>
                        ${crisisBadge}
                    </div>
                    <p class="whitespace-pre-wrap">${message}</p>
                    <div class="text-xs text-gray-500 mt-2 flex items-center">
                        <span>${timeString}</span>
                        <i data-lucide="bot" class="w-3 h-3 ml-2"></i>
                    </div>
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    
    // Re-initialize Lucide icons
    lucide.createIcons();
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTyping(show) {
    const indicator = document.getElementById('typing-indicator');
    if (show) {
        indicator.classList.remove('hidden');
    } else {
        indicator.classList.add('hidden');
    }
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Send message on Enter key (but not Shift+Enter)
messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Auto-scroll to bottom on load
document.addEventListener('DOMContentLoaded', function() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
    lucide.createIcons();
});
</script>
{% endblock %}
