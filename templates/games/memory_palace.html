{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-4xl font-bold text-pink-600 mb-4">üè∞ Memory Palace</h1>
        <p class="text-lg text-gray-600 mb-8 hindi-text">‡§∏‡•ç‡§Æ‡•É‡§§‡§ø ‡§Æ‡§π‡§≤ - Build your virtual study palace and strengthen memory</p>
        
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
            <div class="memory-palace-container">
                <div id="rooms-grid" class="grid grid-cols-3 md:grid-cols-4 gap-4 mb-8">
                    <!-- Rooms will be generated by JavaScript -->
                </div>
                
                <div id="room-details" class="bg-gray-50 rounded-lg p-6 min-h-40">
                    <h3 class="text-xl font-semibold mb-4">Select a room to start building memories</h3>
                    <p class="text-gray-600">Click on any room above to add study items and create memory associations.</p>
                </div>
                
                <div class="memory-controls mt-6">
                    <input type="text" id="memory-input" class="border border-gray-300 rounded-lg px-4 py-2 w-full max-w-md" placeholder="Add study item or concept..." maxlength="100">
                    <button id="add-memory" class="bg-pink-600 hover:bg-pink-700 text-white px-6 py-2 rounded-lg ml-2 mt-2 md:mt-0">
                        Add to Room
                    </button>
                </div>
                
                <div class="palace-stats grid grid-cols-3 gap-4 text-center mt-8">
                    <div>
                        <div id="total-items" class="text-2xl font-bold text-pink-600">0</div>
                        <div class="text-sm text-gray-600">Total Items</div>
                    </div>
                    <div>
                        <div id="rooms-used" class="text-2xl font-bold text-purple-600">0</div>
                        <div class="text-sm text-gray-600">Rooms Used</div>
                    </div>
                    <div>
                        <div id="memory-strength" class="text-2xl font-bold text-blue-600">0%</div>
                        <div class="text-sm text-gray-600">Memory Strength</div>
                    </div>
                </div>
                
                <div class="palace-actions mt-6">
                    <button id="practice-recall" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg mr-4">
                        Practice Recall
                    </button>
                    <button id="clear-palace" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg">
                        Clear Palace
                    </button>
                </div>
            </div>
        </div>
        
        <div class="text-center">
            <a href="/game_zone" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-lg font-semibold">
                Back to Game Zone
            </a>
        </div>
    </div>
</div>

<style>
.room-card {
    background: linear-gradient(135deg, #fce7f3, #f3e8ff);
    border: 2px solid #e5e7eb;
    border-radius: 1rem;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.room-card:hover {
    border-color: #ec4899;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(236, 72, 153, 0.15);
}

.room-card.selected {
    border-color: #ec4899;
    background: linear-gradient(135deg, #ec4899, #8b5cf6);
    color: white;
}

.room-card.has-items {
    border-color: #10b981;
}

.room-card.has-items::after {
    content: '‚úì';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    color: #10b981;
    font-weight: bold;
    font-size: 1.2rem;
}

.room-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.room-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.item-count {
    font-size: 0.75rem;
    opacity: 0.8;
}

.memory-item {
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    margin: 0.25rem;
    display: inline-block;
    font-size: 0.875rem;
}

.recall-mode {
    background: #fef3c7;
    border: 2px solid #f59e0b;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-top: 1rem;
}
</style>

<script>
class MemoryPalace {
    constructor() {
        this.rooms = [
            { id: 'library', name: 'Library', icon: 'üìö', items: [] },
            { id: 'bedroom', name: 'Bedroom', icon: 'üõèÔ∏è', items: [] },
            { id: 'kitchen', name: 'Kitchen', icon: 'üç≥', items: [] },
            { id: 'garden', name: 'Garden', icon: 'üå∏', items: [] },
            { id: 'study', name: 'Study Room', icon: 'üíª', items: [] },
            { id: 'living', name: 'Living Room', icon: 'üõãÔ∏è', items: [] },
            { id: 'bathroom', name: 'Bathroom', icon: 'üöø', items: [] },
            { id: 'garage', name: 'Garage', icon: 'üöó', items: [] }
        ];
        
        this.selectedRoom = null;
        this.recallMode = false;
        this.totalItems = 0;
        
        this.initializeGame();
        this.loadProgress();
        this.updateStats();
    }
    
    initializeGame() {
        this.renderRooms();
        this.setupEventListeners();
        this.renderRoomDetails();
    }
    
    renderRooms() {
        const grid = document.getElementById('rooms-grid');
        grid.innerHTML = '';
        
        this.rooms.forEach(room => {
            const roomCard = document.createElement('div');
            roomCard.className = `room-card ${room.items.length > 0 ? 'has-items' : ''}`;
            roomCard.style.position = 'relative';
            roomCard.dataset.roomId = room.id;
            
            roomCard.innerHTML = `
                <div class="room-icon">${room.icon}</div>
                <div class="room-name">${room.name}</div>
                <div class="item-count">${room.items.length} items</div>
            `;
            
            roomCard.addEventListener('click', () => this.selectRoom(room.id));
            grid.appendChild(roomCard);
        });
    }
    
    selectRoom(roomId) {
        this.selectedRoom = roomId;
        this.updateRoomSelection();
        this.renderRoomDetails();
    }
    
    updateRoomSelection() {
        document.querySelectorAll('.room-card').forEach(card => {
            card.classList.remove('selected');
            if (card.dataset.roomId === this.selectedRoom) {
                card.classList.add('selected');
            }
        });
    }
    
    renderRoomDetails() {
        const details = document.getElementById('room-details');
        
        if (!this.selectedRoom) {
            details.innerHTML = `
                <h3 class="text-xl font-semibold mb-4">Select a room to start building memories</h3>
                <p class="text-gray-600">Click on any room above to add study items and create memory associations.</p>
            `;
            return;
        }
        
        const room = this.rooms.find(r => r.id === this.selectedRoom);
        
        details.innerHTML = `
            <div class="flex items-center mb-4">
                <span class="text-2xl mr-2">${room.icon}</span>
                <h3 class="text-xl font-semibold">${room.name}</h3>
            </div>
            <div class="memory-items-container">
                ${room.items.length === 0 ? 
                    '<p class="text-gray-500 italic">No items yet. Add some study materials!</p>' : 
                    room.items.map(item => `<span class="memory-item">${item}</span>`).join('')
                }
            </div>
            <div class="mt-4">
                <p class="text-sm text-gray-600">
                    <strong>Memory Tip:</strong> Visualize each item in specific locations within this ${room.name.toLowerCase()}. 
                    The more vivid and unusual the association, the stronger your memory will be!
                </p>
            </div>
        `;
    }
    
    setupEventListeners() {
        document.getElementById('add-memory').addEventListener('click', () => {
            this.addMemoryItem();
        });
        
        document.getElementById('memory-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.addMemoryItem();
            }
        });
        
        document.getElementById('practice-recall').addEventListener('click', () => {
            this.startRecallPractice();
        });
        
        document.getElementById('clear-palace').addEventListener('click', () => {
            this.clearPalace();
        });
    }
    
    addMemoryItem() {
        const input = document.getElementById('memory-input');
        const item = input.value.trim();
        
        if (!item || !this.selectedRoom) {
            if (!this.selectedRoom) {
                alert('Please select a room first!');
            }
            return;
        }
        
        const room = this.rooms.find(r => r.id === this.selectedRoom);
        room.items.push(item);
        input.value = '';
        
        this.totalItems++;
        this.renderRooms();
        this.renderRoomDetails();
        this.updateStats();
        this.saveProgress();
        
        this.showAddedFeedback(room.name, item);
    }
    
    showAddedFeedback(roomName, item) {
        const feedback = document.createElement('div');
        feedback.className = 'fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg z-50';
        feedback.innerHTML = `
            <strong>Added to ${roomName}:</strong><br>
            "${item}"
        `;
        document.body.appendChild(feedback);
        
        setTimeout(() => {
            feedback.remove();
        }, 3000);
    }
    
    startRecallPractice() {
        if (this.totalItems === 0) {
            alert('Add some items to your palace first!');
            return;
        }
        
        const details = document.getElementById('room-details');
        details.innerHTML = `
            <div class="recall-mode">
                <h3 class="text-xl font-semibold mb-4">üß† Memory Recall Practice</h3>
                <p class="mb-4">Walk through your palace mentally and try to recall all items in each room.</p>
                <div class="recall-rooms">
                    ${this.rooms.filter(r => r.items.length > 0).map(room => `
                        <div class="mb-4">
                            <h4 class="font-semibold">${room.icon} ${room.name} (${room.items.length} items)</h4>
                            <div class="recall-items mt-2 space-y-1">
                                ${room.items.map((item, index) => `
                                    <div class="recall-item bg-white p-2 rounded border cursor-pointer" 
                                         data-room="${room.id}" data-index="${index}">
                                        <span class="item-text" style="opacity: 0;">???</span>
                                        <span class="reveal-text hidden">${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-6">
                    <button id="reveal-all" class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded mr-4">
                        Reveal All
                    </button>
                    <button id="end-recall" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">
                        End Practice
                    </button>
                </div>
            </div>
        `;
        
        // Add click handlers for recall items
        document.querySelectorAll('.recall-item').forEach(item => {
            item.addEventListener('click', () => {
                const itemText = item.querySelector('.item-text');
                const revealText = item.querySelector('.reveal-text');
                
                if (itemText.style.opacity === '0') {
                    itemText.textContent = revealText.textContent;
                    itemText.style.opacity = '1';
                    item.style.backgroundColor = '#dcfce7';
                }
            });
        });
        
        document.getElementById('reveal-all').addEventListener('click', () => {
            document.querySelectorAll('.recall-item').forEach(item => {
                const itemText = item.querySelector('.item-text');
                const revealText = item.querySelector('.reveal-text');
                itemText.textContent = revealText.textContent;
                itemText.style.opacity = '1';
                item.style.backgroundColor = '#dcfce7';
            });
        });
        
        document.getElementById('end-recall').addEventListener('click', () => {
            this.renderRoomDetails();
        });
    }
    
    clearPalace() {
        if (confirm('Are you sure you want to clear your entire Memory Palace? This cannot be undone.')) {
            this.rooms.forEach(room => {
                room.items = [];
            });
            this.totalItems = 0;
            this.selectedRoom = null;
            
            this.renderRooms();
            this.renderRoomDetails();
            this.updateStats();
            this.saveProgress();
            
            alert('Your Memory Palace has been cleared. Start building new memories!');
        }
    }
    
    updateStats() {
        const roomsUsed = this.rooms.filter(r => r.items.length > 0).length;
        const memoryStrength = Math.min(100, Math.floor((this.totalItems / 50) * 100));
        
        document.getElementById('total-items').textContent = this.totalItems;
        document.getElementById('rooms-used').textContent = roomsUsed;
        document.getElementById('memory-strength').textContent = memoryStrength + '%';
    }
    
    saveProgress() {
        const progress = {
            rooms: this.rooms,
            totalItems: this.totalItems
        };
        localStorage.setItem('memoryPalaceProgress', JSON.stringify(progress));
    }
    
    loadProgress() {
        const saved = localStorage.getItem('memoryPalaceProgress');
        if (saved) {
            const progress = JSON.parse(saved);
            if (progress.rooms) {
                progress.rooms.forEach((savedRoom, index) => {
                    if (this.rooms[index]) {
                        this.rooms[index].items = savedRoom.items || [];
                    }
                });
            }
            this.totalItems = progress.totalItems || 0;
        }
    }
}

// Initialize the game
document.addEventListener('DOMContentLoaded', () => {
    new MemoryPalace();
});
</script>
{% endblock %}
